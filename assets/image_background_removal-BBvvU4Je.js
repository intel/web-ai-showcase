import{s as k}from"./navbar-B3GQCZKa.js";import{e as L,a as U,R as S}from"./image-O15s_1zf.js";import{A as z}from"./processors-De2tF4GJ.js";import{g as N,d as G,a as F,i as Q,f as h,c as y,r as _,h as V,b as C}from"./utility-Cpztc4yD.js";import{A as q}from"./config-C7GNoNA1.js";const j=""+new URL("person.avif",import.meta.url).href;k("../..");L.allowLocalModels=!1;L.allowRemoteModels=!0;L.backends.onnx.wasm.proxy=!1;const D="transformers-cache",x="RMBG-1.4",H=document.getElementById("upload"),r=document.getElementById("container"),J=document.getElementById("example"),B=document.getElementById("loadModelPromptContent"),w=document.getElementById("loadingModelText"),f=document.getElementById("progress"),A=document.getElementById("progressBar"),X=document.getElementById("loadModelBtn"),Y=document.getElementById("modelPopover"),K=document.getElementById("modelPanelWrapper"),M=N(x),l=G(x);let I=0,R=null,b=null;function W(e){const t=e.file;let n=null;switch(t&&(n=document.getElementById(`${t.match(/\/?([^/.]+?)(?:\.[^/.]+)?$/)[1]}StatusBar`)),e.status){case"download":if(n){I=new Date().getTime();const a=e.file;if(l[a]&&l[a].cached)return;_(w,f),f.appendChild(V(`<div model="${e.name}" file="${e.file}"
        class="relative my-4 rounded-2xl w-full min-h-[30px] bg-stone-200/40 flex items-center justify-between font-mono"
      >
    <div class="relative px-2 z-20" name="statusText"></div>
    <div class="relative px-2 z-20">
      <span name="progressVal">0%</span>
    </div>
    <div
      name="progressBar"
      class="absolute top-0 rounded-2xl z-10 text-right bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"
    ></div>
    </div>`))}break;case"progress":if(n)if(l[e.file]&&l[e.file].cached){n.textContent="loading",y("loading",n),l[e.file].size=e.total;break}else{n.textContent="downloading",y("loading",n),l[e.file].size=e.total;const a=f.querySelector(`div[model="${e.name}"][file="${e.file}"]`);if(a!==null){const o=a.querySelector("div[name='statusText']"),s=a.querySelector("div[name='progressBar']"),c=a.querySelector("span[name='progressVal']");s.style.height||(s.style.height="30px"),s.style.width=e.progress.toFixed(2)+"%",c.textContent=e.progress.toFixed(2)+"%",o.textContent=`${e.file} (${h(e.loaded)} / ${h(e.total)})`;break}}break;case"done":f.classList.contains("hidden")||f.classList.add("hidden"),w.classList.contains("hidden")||w.classList.add("hidden");let i=new Date().getTime();if(n){let a="downloaded",o=0;l[e.file]&&(o=l[e.file].size,l[e.file].cached&&(a="cache loaded")),n.textContent=`${a} in ${((i-I)/1e3).toFixed(2)}s(${h(o)})`,y("loaded",n),o=0}break}}J.addEventListener("click",e=>{e.preventDefault(),O(j)});H.addEventListener("change",function(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=i=>O(i.target.result),n.readAsDataURL(t)});function T(){document.querySelectorAll(".control-entry").forEach(e=>{e.classList.toggle("opacity-25"),e.classList.toggle("cursor-pointer");const t=e.querySelector("input");t&&(t.disabled=!t.disabled),e.disabled=!e.disabled})}F(x,K);function Z(){q[x].resources.map(e=>{const t=C(e),n=document.getElementById(`uploadInput4${t}`);n&&n.addEventListener("change",async function(i){const a=i.target.files;if(!a.length)return;const o=await caches.open(D);for(const s of a){const c=new FileReader;c.onprogress=function(d){if(d.lengthComputable){const u=d.loaded,g=d.total;_(A),A.innerHTML=`
            <div class="relative px-2 z-20" id="StatusText"></div>
            <div class="relative px-2 z-20">
              <span id="ProgressVal">0%</span>
            </div>
            <div
              id="ProgressBar"
              class="absolute top-0 rounded-2xl z-10 text-right bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"
            ></div>
         `;const p=document.getElementById("StatusText"),m=document.getElementById("ProgressBar"),v=document.getElementById("ProgressVal");let E=u/g*100;p.textContent="Uploading model ...",m.style.height||(m.style.height="30px"),m.style.width=`${E}%`,v.textContent=`${h(u)}/${h(g)}`}},c.onload=async function(d){const u=d.target.result,g=new Blob([u]),m=(s.name.split(".").length>0?s.name.split(".")[1]:"")==="json"?"text/plain; charset=utf-8":"binary/octet-stream",v=new Response(g,{headers:{"Content-Length":g.size.toString(),"Accept-Ranges":"bytes","Content-Type":m}}),E=M+e;await o.match(E)||o.put(E,v).then(()=>{console.log(`cache ${e} successfully.`),$()}).catch(P=>{console.error(`cache ${e} failed:`,P)}),A.classList.contains("hidden")||A.classList.add("hidden")},c.readAsArrayBuffer(s)}})})}Z();async function O(e){T();try{R||(R=await U.from_pretrained("briaai/RMBG-1.4",{progress_callback:W,device:"webgpu",dtype:"fp32"})),b||(b=await z.from_pretrained("briaai/RMBG-1.4",{config:{do_normalize:!0,do_pad:!1,do_rescale:!0,do_resize:!0,image_mean:[.5,.5,.5],feature_extractor_type:"ImageFeatureExtractor",image_std:[1,1,1],resample:2,rescale_factor:.00392156862745098,size:{width:1024,height:1024}},device:"webgpu",dtype:"fp32"}));const t=await S.fromURL(e);r.innerHTML=`<div id="loadingIcon" class="absolute_center">
  <div class="lds-ripple">
    <div></div>
    <div></div>
  </div>
</div>`,r.style.backgroundImage=`url(${e})`,r.style.backgroundSize="100% 100%",r.style.backgroundRepeat="no-repeat";const n=t.width/t.height,[i,a]=n>720/480?[720,720/n]:[480*n,480];r.style.width=`${i}px`,r.style.height=`${a}px`;const{pixel_values:o}=await b(t),{output:s}=await R({input:o}),c=await S.fromTensor(s[0].mul(255).to("uint8")).resize(t.width,t.height),d=document.createElement("canvas");d.width=t.width,d.height=t.height;const u=d.getContext("2d");u.drawImage(t.toCanvas(),0,0);const g=u.getImageData(0,0,t.width,t.height);for(let p=0;p<c.data.length;++p)g.data[4*p+3]=c.data[p];u.putImageData(g,0,0),r.append(d),r.style.removeProperty("background-image"),r.style.background='url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQBAMAAADt3eJSAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAGUExURb+/v////5nD/3QAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAUSURBVBjTYwABQSCglEENMxgYGAAynwRB8BEAgQAAAABJRU5ErkJggg==")',T(),document.getElementById("loadingIcon").classList.toggle("hidden")}catch(t){console.log("Error:",t)}}async function $(){let e=await caches.open(D);for(const t of Object.keys(l)){let n="",i="";const a=M+t,o=await e.match(a),s=document.getElementById(`${t.match(/\/?([^/.]+?)(?:\.[^/.]+)?$/)[1]}StatusBar`);!o||!o.ok?(n="unload",i="unload"):(n="cached",i="cache available",l[t].cached=!0,B&&!B.classList.contains("hidden")&&B.classList.add("hidden"),_(document.getElementById(`${C(t)}StatusFlag`))),s&&(y(n,s),s.textContent=i)}}await $();Q(X,Y);
