import{s as k}from"./navbar-B3GQCZKa.js";import{e as x,a as U,R as S}from"./image-O15s_1zf.js";import{A as z}from"./processors-De2tF4GJ.js";import{g as N,d as F,a as G,i as V,f as h,c as y,r as L,h as Q,b as M}from"./utility-BDkhytlL.js";import{T as q,A as j}from"./config-hvj4ggRh.js";k("../..");x.allowLocalModels=!0;x.allowRemoteModels=!1;x.backends.onnx.wasm.proxy=!1;x.backends.onnx.wasm.wasmPaths=q;const H="/assets/person.avif",C="transformers-cache",v="RMBG-1.4",J=document.getElementById("upload"),c=document.getElementById("container"),X=document.getElementById("example"),w=document.getElementById("loadModelPromptContent"),R=document.getElementById("loadingModelText"),f=document.getElementById("progress"),A=document.getElementById("progressBar"),W=document.getElementById("loadModelBtn"),Y=document.getElementById("modelPopover"),K=document.getElementById("modelPanelWrapper"),D=N(v),l=F(v);let I=0,_=null,b=null;function Z(e){const t=e.file;let a=null;switch(t&&(a=document.getElementById(`${t.match(/\/?([^/.]+?)(?:\.[^/.]+)?$/)[1]}StatusBar`)),e.status){case"download":if(a){I=new Date().getTime();const n=e.file;if(l[n]&&l[n].cached)return;L(R,f),f.appendChild(Q(`<div model="${e.name}" file="${e.file}"
        class="relative my-4 rounded-2xl w-full min-h-[30px] bg-stone-200/40 flex items-center justify-between font-mono"
      >
    <div class="relative px-2 z-20" name="statusText"></div>
    <div class="relative px-2 z-20">
      <span name="progressVal">0%</span>
    </div>
    <div
      name="progressBar"
      class="absolute top-0 rounded-2xl z-10 text-right bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"
    ></div>
    </div>`))}break;case"progress":if(a)if(l[e.file]&&l[e.file].cached){a.textContent="loading",y("loading",a),l[e.file].size=e.total;break}else{a.textContent="downloading",y("loading",a),l[e.file].size=e.total;const n=f.querySelector(`div[model="${e.name}"][file="${e.file}"]`);if(n!==null){const o=n.querySelector("div[name='statusText']"),s=n.querySelector("div[name='progressBar']"),r=n.querySelector("span[name='progressVal']");s.style.height||(s.style.height="30px"),s.style.width=e.progress.toFixed(2)+"%",r.textContent=e.progress.toFixed(2)+"%",o.textContent=`${e.file} (${h(e.loaded)} / ${h(e.total)})`;break}}break;case"done":f.classList.contains("hidden")||f.classList.add("hidden"),R.classList.contains("hidden")||R.classList.add("hidden");let i=new Date().getTime();if(a){let n="downloaded",o=0;l[e.file]&&(o=l[e.file].size,l[e.file].cached&&(n="cache loaded")),a.textContent=`${n} in ${((i-I)/1e3).toFixed(2)}s(${h(o)})`,y("loaded",a),o=0}break}}X.addEventListener("click",e=>{e.preventDefault(),O(H)});J.addEventListener("change",function(e){const t=e.target.files[0];if(!t)return;const a=new FileReader;a.onload=i=>O(i.target.result),a.readAsDataURL(t)});function T(){document.querySelectorAll(".control-entry").forEach(e=>{e.classList.toggle("opacity-25"),e.classList.toggle("cursor-pointer");const t=e.querySelector("input");t&&(t.disabled=!t.disabled),e.disabled=!e.disabled})}G(v,K);function ee(){j[v].resources.map(e=>{const t=M(e),a=document.getElementById(`uploadInput4${t}`);a&&a.addEventListener("change",async function(i){const n=i.target.files;if(!n.length)return;const o=await caches.open(C);for(const s of n){const r=new FileReader;r.onprogress=function(d){if(d.lengthComputable){const u=d.loaded,g=d.total;L(A),A.innerHTML=`
            <div class="relative px-2 z-20" id="StatusText"></div>
            <div class="relative px-2 z-20">
              <span id="ProgressVal">0%</span>
            </div>
            <div
              id="ProgressBar"
              class="absolute top-0 rounded-2xl z-10 text-right bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"
            ></div>
         `;const p=document.getElementById("StatusText"),m=document.getElementById("ProgressBar"),B=document.getElementById("ProgressVal");let E=u/g*100;p.textContent="Uploading model ...",m.style.height||(m.style.height="30px"),m.style.width=`${E}%`,B.textContent=`${h(u)}/${h(g)}`}},r.onload=async function(d){const u=d.target.result,g=new Blob([u]),m=(s.name.split(".").length>0?s.name.split(".")[1]:"")==="json"?"text/plain; charset=utf-8":"binary/octet-stream",B=new Response(g,{headers:{"Content-Length":g.size.toString(),"Accept-Ranges":"bytes","Content-Type":m}}),E=D+e;await o.match(E)||o.put(E,B).then(()=>{console.log(`cache ${e} successfully.`),P()}).catch($=>{console.error(`cache ${e} failed:`,$)}),A.classList.contains("hidden")||A.classList.add("hidden")},r.readAsArrayBuffer(s)}})})}ee();async function O(e){T();try{_||(_=await U.from_pretrained("briaai/RMBG-1.4",{progress_callback:Z,device:"webgpu",dtype:"fp32"})),b||(b=await z.from_pretrained("briaai/RMBG-1.4",{config:{do_normalize:!0,do_pad:!1,do_rescale:!0,do_resize:!0,image_mean:[.5,.5,.5],feature_extractor_type:"ImageFeatureExtractor",image_std:[1,1,1],resample:2,rescale_factor:.00392156862745098,size:{width:1024,height:1024}},device:"webgpu",dtype:"fp32"}));const t=await S.fromURL(e);c.innerHTML=`<div id="loadingIcon" class="absolute_center">
  <div class="lds-ripple">
    <div></div>
    <div></div>
  </div>
</div>`,c.style.backgroundImage=`url(${e})`,c.style.backgroundSize="100% 100%",c.style.backgroundRepeat="no-repeat";const a=t.width/t.height,[i,n]=a>720/480?[720,720/a]:[480*a,480];c.style.width=`${i}px`,c.style.height=`${n}px`;const{pixel_values:o}=await b(t),{output:s}=await _({input:o}),r=await S.fromTensor(s[0].mul(255).to("uint8")).resize(t.width,t.height),d=document.createElement("canvas");d.width=t.width,d.height=t.height;const u=d.getContext("2d");u.drawImage(t.toCanvas(),0,0);const g=u.getImageData(0,0,t.width,t.height);for(let p=0;p<r.data.length;++p)g.data[4*p+3]=r.data[p];u.putImageData(g,0,0),c.append(d),c.style.removeProperty("background-image"),c.style.background='url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQBAMAAADt3eJSAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAGUExURb+/v////5nD/3QAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAUSURBVBjTYwABQSCglEENMxgYGAAynwRB8BEAgQAAAABJRU5ErkJggg==")',T(),document.getElementById("loadingIcon").classList.toggle("hidden")}catch(t){console.log("Error:",t)}}async function P(){let e=await caches.open(C);for(const t of Object.keys(l)){let a="",i="";const n=D+t,o=await e.match(n),s=document.getElementById(`${t.match(/\/?([^/.]+?)(?:\.[^/.]+)?$/)[1]}StatusBar`);!o||!o.ok?(a="unload",i="unload"):(a="cached",i="cache available",l[t].cached=!0,w&&!w.classList.contains("hidden")&&w.classList.add("hidden"),L(document.getElementById(`${M(t)}StatusFlag`))),s&&(y(a,s),s.textContent=i)}}await P();V(W,Y);
